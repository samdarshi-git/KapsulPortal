<!-- app\templates\doctor\patient_detail.html -->
{% extends "shared/base.html" %}
{% block content %}

<h2 class="fw-bold mb-4 text-center">ğŸ‘¤ Patient: {{ patient.name }}</h2>

<!-- ====== Quick Links ====== -->
<div class="text-center mb-4">
  <a href="{{ url_for('doctor.patients') }}" class="btn btn-outline-secondary me-2">â¬…ï¸ Back to My Patients</a>

  {% if permissions.allow_alerts %}
    <a href="{{ url_for('doctor.view_alerts', patient_id=patient.id) }}" class="btn btn-outline-info me-2">ğŸ”” Alerts</a>
  {% endif %}
  {% if permissions.allow_analytics %}
    <a href="{{ url_for('doctor.view_analytics', patient_id=patient.id) }}" class="btn btn-outline-success me-2">ğŸ“Š Analytics</a>
  {% endif %}
  {% if permissions.allow_med_update %}
    <a href="{{ url_for('doctor.manage_meds', patient_id=patient.id) }}" class="btn btn-outline-warning me-2">ğŸ’Š Update Medicines</a>
  {% endif %}
</div>

<!-- ====== Device Info ====== -->
{% if device %}
<div class="card shadow-sm p-3 mb-4">
  <h5 class="text-primary fw-bold">Device Info</h5>
  <p><strong>Device Code:</strong> {{ device.device_code }}</p>
  <p><strong>Language:</strong> {{ device.language|upper }}</p>
  <p><strong>Last Sync:</strong> {{ device.last_sync or 'Never' }}</p>
  <p><strong>Pending Sync:</strong>
    {% if device.pending_sync %}
      <span class="badge bg-warning text-dark">Yes</span>
    {% else %}
      <span class="badge bg-success">No</span>
    {% endif %}
  </p>
</div>
{% endif %}

<!-- ====== Medicines Section ====== -->
<div class="card shadow-sm p-3 mb-4">
  <h5 class="fw-bold text-success">ğŸ’Š Current Medicines</h5>
  {% if meds %}
  {% for m in meds %}
  <div class="border rounded p-3 mb-3 bg-light">
    <h6 class="fw-bold text-primary">{{ m.name }}</h6>
    <p><strong>Composition:</strong> {{ m.composition }}</p>
    <p><strong>Importance:</strong> {{ m.importance_level }}</p>
    <p><strong>Quantity:</strong> {{ m.quantity }}</p>
    <p><strong>Expiry:</strong> {{ m.expiry.strftime('%b %Y') }}</p>
    <p><strong>Compartment:</strong> {{ m.compartment }}</p>

    {% if m.dosages %}
    <table class="table table-sm table-bordered mt-2">
      <thead class="table-secondary">
        <tr>
          <th>Start</th><th>End</th><th>Food</th><th>Remark</th>
        </tr>
      </thead>
      <tbody>
        {% for d in m.dosages %}
        <tr>
          <td>{{ d.time_range_start.strftime('%I %p') }}</td>
          <td>{{ d.time_range_end.strftime('%I %p') }}</td>
          <td>{{ d.food_status }}</td>
          <td>{{ d.remark }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
  {% endfor %}
  {% else %}
  <p class="text-muted">No medicines assigned yet.</p>
  {% endif %}
</div>

<!-- ====== Recent Logs ====== -->
<div class="card shadow-sm p-3 mb-4">
  <h5 class="fw-bold text-info">ğŸ“œ Recent Dispense Logs</h5>
  {% if logs %}
  <table class="table table-sm table-hover">
    <thead class="table-light">
      <tr>
        <th>Time</th><th>Medicine</th><th>Food</th><th>Snoozed</th>
      </tr>
    </thead>
    <tbody>
      {% for l in logs %}
      <tr>
        <td>{{ l.taken_time.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>{{ l.med_name }}</td>
        <td>{{ l.food_type }}</td>
        <td>
          {% if l.rescheduled %}
            <span class="badge bg-warning text-dark">Yes</span>
          {% else %}
            <span class="badge bg-success">No</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-muted">No recent activity logs available.</p>
  {% endif %}
</div>

<!-- ====== Send Alert ====== -->
<div class="card shadow-sm p-3">
  <h5 class="fw-bold text-danger">ğŸ“¢ Send Alert to Patient</h5>
  <form method="POST" action="{{ url_for('doctor.send_alert', patient_id=patient.id) }}">
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" class="form-control" name="title" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Message</label>
      <textarea class="form-control" name="message" rows="3" required></textarea>
    </div>
    <button type="submit" class="btn btn-danger w-100">Send Alert</button>
  </form>
</div>

{% endblock %}
